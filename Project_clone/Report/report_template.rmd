---
title: ""
author: ""
date: ""
header-includes:
   - \usepackage{geometry}
   - \usepackage{fancyhdr}
   - \usepackage[swedish]{babel}
   - \usepackage[default]{lato}
   - \usepackage{float}
   - \pagestyle{fancy}
   - \fancyhf{}
   - \lhead{\includegraphics[height=1cm]{./NRM_figures/naturhistoriska-riksmuseet2.png}}
   - \rhead{Centrum för Genetisk Identifiering}
   - \lfoot{}
   - \usepackage{xcolor}
   - \definecolor{forest}{RGB}{60, 122, 94}
   - \definecolor{forest2}{RGB}{20, 72, 54}
   - \usepackage{afterpage}
output:
  pdf_document:
    keep_md: yes
bibliography: references.bib
biblio-style: unsrt
---
```{r setup, include=FALSE, cache = FALSE}
require("knitr")
knitr::opts_chunk$set(eval = TRUE, echo = FALSE, warning = FALSE)
options(knitr.kable.NA = '')

# To place figure where they are declared in the source file:
#knitr::opts_chunk$set(fig.pos = "h", out.extra = "") # try
#knitr::opts_chunk$set(fig.pos = "H", out.extra = "") # force
```

```{r setup2, include=FALSE}
library(tidyverse)
library(ggplot2)
library(cowplot)
library(kableExtra)
library(readxl)
library(wesanderson)
library(vegan)
library(MetaBAnalysis)
```

```{r}
# User set variables:
projectTitle <- "eDNA-detektering av fisk" # The title of this report
projectId <- "XXX-20XX" # Diarienummer assigned to this project
authorName <- "FIRST LAST" # Name of the author of this report

clientName <- "klient" # The name of the client
samplesNo <- "NUMBER" # Number of samples analysed
blastDate <- "MONTH 20XX" # Which month the blast search was performed
sampleCutoff <- "0,X" # Within sample cutoff

commonNo <- "NUMBER" # How many species that stood for [commonPercent] of all sequences
commonPercent <- "NUMBER" # A given large percentage, e.g. "75" or "90" etc.
seqPlotFigures <- "2-X" # Which figure numbers belong to the SeqPlots? e.G. "2" or "2-4" etc.

targetGroup <- "fisk"

primerName1 <- "12S"
primerName2 <- "V16S" # if relevant #add

commonNo2 <- "NUMBER" # same as above but for second primer
commonPercent2 <- "NUMBER" # -"-.
seqPlotFigures2 <- "2-X" # -"-
```

\begin{titlepage}
\center
\vspace{2cm}
NATURHISTORISKA RIKSMUSEET • FORSKAR, BEVARAR OCH FÖRKLARAR • NRM.SE \\
	\colorbox{forest2}{
		\parbox[t]{0.93\textwidth}{ % Outer full width box
			\parbox[t]{0.91\textwidth}{ % Inner box for inner right text margin
				\center % Right align the text
				\fontsize{30pt}{40pt}\selectfont % Title font size, the first argument is the font size and the second is the line spacing, adjust depending on title length
				\vspace{0.7cm} % Space between the start of the title and the top of the grey box
				\textcolor{white}{
				`r projectTitle`}\\
				\vspace{0.5cm} 
				\Large
				\textcolor{white}{
				Diarienummer NRM `r projectId`}\\
				\vspace{0.7cm} % Space between the end of the title and the bottom of the grey box
			}
		}
	}
   \vfill % Space between the title box and author information
	
	%------------------------------------------------
	%	Author name and information
	%------------------------------------------------
	\center
	\includegraphics[width=330mm]{./NRM_figures/nrm-logo-staende-svensk-fullfarg}
	\vspace{2cm}
	%\parbox[t]{0.93\textwidth}{ % Box to inset this section slightly
	%	\raggedleft % Right align the text
	%	\large % Increase the font size
	%	{\Large `r authorName`}\\[4pt] % Extra space after name
	%	Centrum för genetisk identifiering\\
	%	}

\end{titlepage}

Centrum för genetisk identifiering (CGI) vid Naturhistoriska riksmuseet är en
uppdragsfinansierad verksamhet som erbjuder myndigheter och organisationer hjälp
med genetiska analyser av biologiskt material.

```{r}
options(scipen = 5)

FixMillion <- function(inNumber) {
  if(inNumber < 100000) {
    return(inNumber)
  } else {
    smallNumber <- inNumber / 1000000
    roundNumber <- round(smallNumber, 1)
    outNumber <- gsub("\\.", ",", roundNumber)
    return(paste(outNumber, "miljoner"))
  }
}

FixPercent <- function(inNumber) {
  bigNumber <- inNumber * 100
  roundNumber <- round(bigNumber, 0)
  outNumber <- gsub("\\.", ",", roundNumber)
  return(outNumber)
}

# Load and modify data:
sampleMetaData <- readRDS("sampleMetaData.rds")
rawSeqs <- sampleMetaData$rawSeqs
primerSeqs <- sampleMetaData$primerSeqs
groupSeqs <- sampleMetaData$groupSeqs
allResults <- readRDS("allResults.rds")
groupData <- allResults$Clean
groupSpecies <- cbind(groupData$Latin, groupData$Swedish)
colnames(groupSpecies) <- c("Latin", "Svenska")

# Assign variables:
speciesNo <- nrow(groupSpecies) # Number of species found with first primer
totalSeqs <- FixMillion(sum(rawSeqs)) # Total number of raw sequences
minSeqs <- FixMillion(min(rawSeqs)) # Number of sequences in the sample with fewest sequences
maxSeqs <- FixMillion(max(rawSeqs)) # Number of sequences in the sample with most sequences
primerPercent <- FixPercent(primerSeqs / sum(rawSeqs)) # Percentage of sequences that contained primers
groupPercent <- FixPercent(groupSeqs / primerSeqs) # Percentage of sequences belonging to target group

primerText1 <- paste0("För ", primerName1, " innehöll omkring ", primerPercent, "% av sekvenserna förväntade primers och var av tillräckligt god kvalitet för att bibehållas i analysen. Av dessa tillhörde ~", groupPercent, "% av sekvenserna ", targetGroup, ". Sekvenserna från ", targetGroup, " tillhörde ", speciesNo, " olika arter (se figur 1 och ", seqPlotFigures, " för relativa andelar sekvenser från varje art i varje prov) där de vanligaste ", commonNo, " arterna stod för över ", commonPercent, "% av sekvenserna från ", targetGroup, " (se figur 1).")

if("allResults2.rds" %in% list.files(".")) { 
  primerSeqs2 <- sampleMetaData$primerSeqs2
  groupSeqs2 <- sampleMetaData$groupSeqs2
  allResults2 <- readRDS("allResults2.rds")
  groupData2 <- allResults2$Clean
  groupSpecies2 <- cbind(groupData2$Latin, groupData2$Swedish)
  colnames(groupSpecies2) <- c("Latin", "Svenska")
  primerPercent2 <- FixPercent(primerSeqs2 / sum(rawSeqs)) # Percentage of sequences that contained primers
  groupPercent2 <- FixPercent(groupSeqs2 / primerSeqs2) # Percentage of sequences belonging to target group
  speciesNo2 <- nrow(groupSpecies2) # Number of species found
  primerText2 <- paste0("För ", primerName2, " innehöll omkring ", primerPercent2, "% av sekvenserna förväntade primers och var av tillräckligt god kvalitet för att bibehållas i analysen. Av dessa tillhörde ~", groupPercent2, "% av sekvenserna ", targetGroup, ". Sekvenserna från ", targetGroup, " tillhörde ", speciesNo2, " olika arter (se figur 1 och ", seqPlotFigures2, " för relativa andelar sekvenser från varje art i varje prov) där de vanligaste ", commonNo2, " arterna stod för över ", commonPercent2, "% av sekvenserna från ", targetGroup, " (se figur 1).")
} else {
  speciesNo2 <- c() # No species found, since no other primer
  primerText2 <- ""
}

speciesNoAll <- nrow(unique(rbind(groupSpecies, groupSpecies2))) # Number of species from both primers
```

## Uppdrag
CGI har fått i uppdrag av `r clientName` att med hjälp av eDNA (environmental DNA) 
detektera vilka arter av `r targetGroup` som finns i `r samplesNo` vattenprover.

## Material och metoder
Prover togs av `r clientName` med provtagningsmaterial från CGI. DNA från vatten fångades med ett Sylphium filter med porstorlek 0.8 µm.
Efter filtrering tillsattes ATL-buffer och prover skickades till Naturhistoriska för fortsatt analys.

### Molekylära metoder
Proteinas K tillsattes till filter med ATL-buffer och prover inkuberades vid 56° i minst 4 timmar. DNA-extraktion utfördes därefter med en Kingfisher extraktionsrobot (model Duo prime eller Flex) och ett "Omega
MagBind Blood and Tissue" DNA-extraktionskit enligt beskrivning från
tillverkaren. För analyserna amplifierades en kort bit av mitokondrien med 
primers (se Tabell 1) beskrivna i en tidigare studie [@miya2015mifish] med 
PCR-reaktioner som optimerats för flerartsanalys med sekvensering.

```{r tab1, echo=FALSE}
library(kableExtra)
library(readxl)

# Edit this:
primerChoice <- c(2) # change to desired row(s) in primer_data.xlsx, default = 2 = mifish

# Not this (generally):
primerInfo <- read_excel("primer_data.xlsx")
primerNames <- unlist(lapply(1:length(primerChoice), function(x) {paste0(primerInfo[primerChoice[x],1], footnote_marker_symbol(x))}))
primerInfo[primerChoice, 1] <- primerNames
kable(primerInfo[primerChoice,c(1:3,5)], "latex",
				 caption = "Sekvenser för de primers som använts för detektion av eDNA. Temperatur är annealingtemperatur i PCR-reaktionerna.",
				 booktabs = T, escape = F) %>%
				 kable_styling(latex_options = "hold_position", font_size = 8) %>%
			         footnote(symbol = apply(primerInfo[primerChoice, 7], 2, function(x) {x})) # works fully for several primers
```

### Bioinformatiska analysmetoder
Från rådata trimmades primersekvenser bort med hjälp av programmet cutadapt 
[@martin2011cutadapt] och kvarvarande data analyserades med R-paketet dada2 
[@callahan2016dada2]. Dada2 använder sekvensdata från prover för att identifiera
unika sekvenser av biologiskt ursprung och hur många gånger dessa hittas i 
vardera prov. Kvarvarande sekvensvarianter spårades till art genom att med hjälp
av verktyget BLAST (Basic Local Alignment Search Tool)  [@altschul1990basic] 
jämföra sekvenserna mot NCBIs öppna nukleotiddatabas (Nucleotide collection).
Vår sökning utfördes `r blastDate`. Träffar med en identifikation på lägre än
95% exkluderades direkt. Dessutom exkluderades träffar från varje prov där
träffen utgjorde mindre än `r sampleCutoff`% av det totala antalet sekvenser inom det provet
för att minska risken för falskt positiva träffar.

## Resultat
PCR-reaktioner genererade rena amplifieringar av förväntad storlek i alla tre
replikat för alla prover och bedömdes därmed lämpliga för att skapa
sekvenseringsbibliotek. Biblioteken skapades av CGI och sekvenserades av
BMKGene på ett NovaSeq-instrument (PE150).

### Fauna
Det totala antalet fragment efter sekvensering av proverna var `r totalSeqs`,
där enskilda prov hade mellan `r minSeqs` och `r maxSeqs` fragment.
`r primerText1`
`r primerText2`
<!-- Omkring `r primerPercent`% av sekvenserna -->
<!-- innehöll förväntade primers och var av tillräckligt god kvalitet för att -->
<!-- bibehållas i analysen. Av dessa tillhörde ~`r groupPercent`% av sekvenserna `r targetGroup`. Sekvenserna från `r targetGroup` -->
<!-- tillhörde `r speciesNo` olika arter (se tabell 2 samt se figur 1 och `r seqPlotFigures` för -->
<!-- relativa andelar sekvenser från varje art i varje prov) där de vanligaste `r commonNo` -->
<!-- arterna stod för över `r commonPercent`% av sekvenserna från `r targetGroup` (se figur 1). -->
Se tabell 2 för samtliga identifierade arter av `r targetGroup`. Övriga sekvenser var av låg kvalitet eller var spår av andra organismer.

```{r tab2, echo=FALSE}
fixedCaption <- paste(paste("Tabell över latinska och svenska namn på de arter av", targetGroup, "som identifierats i proverna. Om sekvenser ej kunde bestämmas till exakt art anges i dessa fall "), "sp.", " eller vilka två arter det kan handla om.", sep = "'")

if("allResults2.rds" %in% list.files(".")) {
  tableSpecies <- unique(rbind(groupSpecies, groupSpecies2))
} else {
  tableSpecies <- groupSpecies
}

kable(tableSpecies, "latex",
      caption = fixedCaption, 
      booktabs = T, escape = F)%>%
      kable_styling(latex_options = "hold_position")%>%
      column_spec(1, italic = TRUE)
```

```{r fig1, fig.height=14, fig.width=11, echo=FALSE, fig.cap=paste0("Fördelning i procent av antal sekvenser från olika arter av ", targetGroup, " i proverna detekterade med hjälp av primer ", primerName1, ". Den översta stapeln \'Totalt\' visar en sammanslagning av alla dessa sekvenser från alla prover.")}
# if figure is too tall or short, change to either fig.height=7 or fig.height=14 on above line
library(MetaBAnalysis)

# Prepare the count data:
groupCounts <- groupData[, -c(1:2), drop = FALSE]
if(ncol(groupCounts) > 1) { # if more than one sample, add a total of all samples to the plot
  groupCounts <- cbind(groupCounts, Totalt = rowSums(groupCounts))
}
figureSpecies <- data.frame(groupSpecies)$Svenska # change Svenska to Latin if needed

# Sort samples numerically:
groupCounts <- groupCounts[, order(as.numeric(gsub("[^0-9]+", "", colnames(groupCounts))))]

# Plot:
FractionPlot(data = groupCounts, species = figureSpecies, col = MetaBAnalysis:::color25, inset = c(-0.3, 0.01))
```

```{r fig2, fig.height=14, fig.width=11, echo=FALSE, fig.cap=paste0("Fördelning i procent av antal sekvenser från olika arter av ", targetGroup, " i proverna detekterade med hjälp av primer ", primerName2, ". Den översta stapeln \'Totalt\' visar en sammanslagning av alla dessa sekvenser från alla prover.")}
# if figure is too tall or short, change to either fig.height=7 or fig.height=14 on above line

if("allResults2.rds" %in% list.files(".")) { 
  library(MetaBAnalysis)
  # Prepare the count data:
  groupCounts2 <- groupData2[, -c(1:2), drop = FALSE]
  if(ncol(groupCounts2) > 1) { # if more than one sample, add a total of all samples to the plot
    groupCounts2 <- cbind(groupCounts2, Totalt = rowSums(groupCounts2))
  }
  figureSpecies2 <- data.frame(groupSpecies2)$Svenska # change Svenska to Latin if needed
  
  # Sort samples numerically:
  groupCounts2 <- groupCounts2[, order(as.numeric(gsub("[^0-9]+", "", colnames(groupCounts2))))]
  
  # Plot:
  FractionPlot(data = groupCounts2, species = figureSpecies, col = MetaBAnalysis:::color25, inset = c(-0.3, 0.01))
}
```

```{r fig3, fig.height=7, fig.width=14, echo=FALSE, fig.cap="Simpsons diversitetsindex för varje prov. Simpson (1 - D) ger sannolikheten att två slumpmässiga sekvenser dragna ur ett prov tillhör samma art. En högre siffra föreslår en högre diversitet inom det provet."}
PlotAlphaDiv <- function(plotData, dataNames, plotCol) {
  if(length(plotData) == 1 && !is.list(plotData)) {
    dataList <- as.list(plotData)
  } else {
    dataList <- plotData
  }
  .addSize <- function(group) {
    name <- paste0(group[1], "\nn=", length(group[[2]]))
    return(name)
  }
  newNames <- apply(X = cbind(dataNames, plotData), MARGIN = 1, FUN = .addSize)
  ylabel <- ""
  if(length(newNames) == 1) {ylabel <- newNames}
  par(mar = c(4.1, 9.1, 4.1, 12.1), xpd = TRUE, las = 1, srt = 0, cex = 1.2, bty = "n")
  boxplot(dataList, horizontal = TRUE, names = newNames, col = plotCol, las = 1)
  text(-0.05, 1, ylabel, adj = 1)
}

# Format data:
countsMatrix <- as.matrix(t(allResults$Clean[,-c(1, 2)]))
# simpValues <- vegan::diversity(x = countsMatrix, index = "simpson")

# Calculate Simpson:
if("allResults2.rds" %in% list.files(".")) { # if two primers
  countsMatrix2 <- as.matrix(t(allResults2$Clean[,-c(1, 2)]))
  plotInput <- list(vegan::diversity(x = countsMatrix, index = "simpson"), vegan::diversity(x = countsMatrix2, index = "simpson"))
  plotNames <- list(primerName1, primerName2) # needs to be the same length as 'plotInput'
} else {
  plotInput <- list(vegan::diversity(x = countsMatrix, index = "simpson"))
  plotNames <- list("Alla prover") # needs to be the same length as 'plotInput'
}

# Group samples (optional):
#group1 <- split(simpValues, c('a', 'b'))$a
#group2 <- split(simpValues, c('a', 'b'))$b

# Prepare plot variables:
# plotInput <- list(simpValues) # add several if needed
# plotNames <- list("Alla prover") # needs to be the same length as 'plotInput'
plotPalette <- wesanderson::wes_palette("Zissou1")#[c(3, 1)]

PlotAlphaDiv(plotData = plotInput, dataNames = plotNames, plotCol = plotPalette)
```

```{r include=FALSE}
groupDataFrame <- as.data.frame(groupData)
names(groupDataFrame) <- make.names(names(groupDataFrame))

options(scipen = 5)

groupDataFrame$Swedish <- str_pad(groupDataFrame$Swedish, side = "left", pad = " ", width = max(nchar(groupDataFrame$Swedish)))

indplots <- list()
for(i in names(groupDataFrame[3:ncol(groupDataFrame)])) {
   indplots[[i]] <- SeqPlot(data = groupDataFrame, sample = i, title = i, species = "Swedish", log10 = FALSE)
}

if("allResults2.rds" %in% list.files(".")) { # if two primers
  groupDataFrame2 <- as.data.frame(groupData2)
  names(groupDataFrame2) <- make.names(names(groupDataFrame2))
  
  options(scipen = 5)
  
  groupDataFrame2$Swedish <- str_pad(groupDataFrame2$Swedish, side = "left", pad = " ", width = max(nchar(groupDataFrame2$Swedish)))
  
  indplots2 <- list()
  for(i in names(groupDataFrame2[3:ncol(groupDataFrame2)])) {
     indplots2[[i]] <- SeqPlot(data = groupDataFrame2, sample = i, title = i, species = "Swedish", log10 = FALSE)
}
  
}
```

\newpage

## Sammanfattning
Undersökning med eDNA på `r samplesNo` vattenprover har identifierat sekvenser
från `r speciesNoAll` olika arter av `r targetGroup`. Vår bedömning är att
de detekterade arterna med stor sannolikhet finns närvarande i proverna, men eDNA är indirekta spår vilket innebär att spår inte nödvändigtvis kommer från individer som lever på provtagen lokal. Vidare innebär ett negativt resultat (alltså arter som inte detekterades) inte
nödvändigtvis att dessa arter är frånvarande. Vi vill även påpeka att
DNA rör sig med vatten och att en eventuell lokal uppströms kan påverka vilka
arter som detekteras vid en lokal nedströms. Detta kan vara värt att ha i åtanke
vid tolkning av inventeringsresultat från eDNA.

```{r echo=FALSE, fig.height=13, fig.width=9, fig.cap=paste0("Antal sekvenser från varje art av ", targetGroup, " detekterade med ", primerName1, " i enskilda prover.")}
# options(scipen = 5)
plot_grid(plotlist = indplots[1:5], align = "v", axis = "l", ncol = 1)
```

```{r echo=FALSE, fig.height=13, fig.width=9, fig.cap=paste0("Antal sekvenser från varje art av ", targetGroup, " detekterade med ", primerName2, " i enskilda prover.")}
# options(scipen = 5)
if("allResults2.rds" %in% list.files(".")) { # if two primers
  plot_grid(plotlist = indplots2[1:5], align = "v", axis = "l", ncol = 1)
}
```

## Projektinformation
Analysdata och resultat lagras tills vidare hos NRM. Vid eventuella
framtida frågor i detta ärende kontakta NRM på antingen cgi@nrm.se
eller registrator@nrm.se och ange diarienummer i mailets
ämnesrad. Artbestämning av DNA-sekvenser sker genom jämförelse med
databaser. Vi använder den internationellt största och mest kompletta
databasen i våra försök att spåra ursprung till de sekvenser vi
rapporterar, men det finns både luckor och felaktigheter i
databasen. Arterna i denna rapport är den bästa informationen som
finns att tillgå vid söktillfället, men om databasen uppdateras kan
kopplingen mellan sekvens och art komma att ändras.

\newpage

## Referenser 
